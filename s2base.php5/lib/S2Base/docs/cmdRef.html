<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html><head><!-- don't edit start --><title>Seasar - DI Container with AOP -</title><meta http-equiv="Content-Type" content="text/html; charset=Shift_JIS">
<meta http-equiv="Content-Style-Type" content="text/css">
<link href="seasar_b.css" type="text/css" rel="stylesheet" media="screen"><link href="seasar_p.css" type="text/css" rel="stylesheet" media="print"><script src="seasar_b.js" type="text/JavaScript" language="JavaScript"></script></head>


<body onload="preload('ja')"><table align="left" border="0" cellpadding="0" cellspacing="0" width="100%"><tbody><tr>
<td align="left" valign="top" width="780"><table class="white" border="0" cellpadding="0" cellspacing="0" width="780">
<tbody><tr><td colspan="7"><img src="images/top01_b.gif" alt="" height="5" width="780"></td></tr>
<tr><td width="235"><img src="images/top02_b.gif" alt="Seasar" height="117" width="235"></td>
<td colspan="3"><img src="images/top03.gif" alt="DI Container with AOP" height="117" width="289"></td>
<td colspan="3"><img src="images/spacer.gif" alt="" height="117" width="256"></td>
</tr><tr><td rowspan="2"><img src="images/top04.gif" alt="" height="49" width="235"></td>
<td><a href="http://www.seasar.org/index.html"><img src="images/menu01_b_ja.gif" alt="" id="menu01" onmouseover="swap(1)" onmouseout="restore(1)" border="0" height="30" width="78"></a></td>
<td><a href="http://www.seasar.org/projects.html"><img src="images/menu02_b_ja.gif" alt="" id="menu02" onmouseover="swap(2)" onmouseout="restore(2)" border="0" height="30" width="101"></a></td>
<td><a href="http://www.seasar.org/products.html"><img src="images/menu03_b_ja.gif" alt="" id="menu03" onmouseover="swap(3)" onmouseout="restore(3)" border="0" height="30" width="110"></a></td>
<td><a href="http://www.seasar.org/resources.html"><img src="images/menu04_b_ja.gif" alt="" id="menu04" onmouseover="swap(4)" onmouseout="restore(4)" border="0" height="30" width="113"></a></td>
<td><img src="images/menu05_b_ja.gif" alt="" id="menu05" onmouseover="swap(5)" onmouseout="restore(5)" border="0" height="30" width="109"></td>
<td width="34"><img src="images/menu06.gif" alt="" height="30" width="34"></td></tr><tr>
<td colspan="6"><img src="images/spacer.gif" alt="" height="19" width="545"></td></tr></tbody></table>
<table class="white" border="0" cellpadding="0" cellspacing="0" width="780">
<tbody><tr align="left" valign="top"><td width="18"><img src="images/spacer.gif" alt="" height="14" width="18"></td><td class="main" width="744">
<!-- don't edit end -->
<!-- document start -->

<ul>
<li><a href="#cmdRef">コマンドリファレンス</a></li>
  <ul>
   <li><a href="#command">command コマンド</a></li>
   <li><a href="#dao">dao コマンド</a></li>
   <li><a href="#dicon">dicon コマンド</a></li>
   <li><a href="#entity">entity コマンド</a></li>
   <li><a href="#goya">goya コマンド</a></li>
   <li><a href="#interceptor">interceptor コマンド</a></li>
   <li><a href="#module">module コマンド</a></li>
   <li><a href="#service">service コマンド</a></li>
   <li><a href="#test">test タスク</a></li>
   <li><a href="#gen-dao">gen-dao タスク</a></li>
  </ul>
</ul>
<br>

<h2><a name="cmdRef">コマンドリファレンス</a></h2>

<h3><a name="command">command コマンド</a></h3>

<h4>説明</h4>
<p>
S2Baseの新しいコマンドを作成します。作成したコマンドは、コマンドリストに表示されます。
</p>
<h4>実行例</h4>
<p>s2base.php5 ディレクトリで phing を実行します。</p>
<pre>
% phing
Buildfile: /seasar.php/workspace/s2base.php5/build.xml

project > prepare:
      [php] Evaluating PHP expression: require_once('config/environment.inc.php')
      [php] Evaluating PHP expression: require_once('lib/S2Base/S2Base.cmd.php')

project > com:

[ Command list ]
0 : [ EXIT ]
1 : command
2 : dao
3 : dicon
4 : entity
5 : goya
6 : interceptor
7 : module
8 : service
choice ? : 1     &lt;--- 1 : command を選択

command name ? : sample
[INFO ] create : /seasar.php/workspace/s2base.php5/app/commands/SampleCommand.class.php
                                                                  ↑
BUILD FINISHED                                            クラスファイルが作成されます。

Total time: 18.0426 seconds
%
</pre>

SampleCommand クラスの execute メソッドを編集します。
<pre>
% cat app/commands/SampleCommand.class.php
&lt;?php
class SampleCommand
    implements S2Base_GenerateCommand {

    public function getName(){
        return "sample";    &lt;--- コマンドリストに表示されるコマンド名
    }

    public function execute(){
        print __METHOD__ . " called.\n";    &lt;--- print 文を追記
    }

}
?&gt;
%
</pre>

再度 phing を実行すると sample コマンドが選択できます。
<pre>
% phing
Buildfile: /seasar.php/workspace/s2base.php5/build.xml

project > prepare:
      [php] Evaluating PHP expression: require_once('config/environment.inc.php')
      [php] Evaluating PHP expression: require_once('lib/S2Base/S2Base.cmd.php')

project > com:

[ Command list ]
0 : [ EXIT ]
1 : command
2 : dao
3 : dicon
4 : entity
5 : goya
6 : interceptor
7 : module
8 : service
9 : sample     &lt;--- 新規作成したコマンドが表示されます。
choice ? : 9
SampleCommand::execute called.    &lt;--- コマンドクラスの execute メソッドが実行されます。

BUILD FINISHED

Total time: 2.0847 seconds
%
</pre>

<br>
<h3><a name="dao">dao コマンド</a></h3>
<h4>説明</h4>
<p>
S2Dao で必要な dao インタフェース、entity クラス、dao コンポーネント定義済みの dicon ファイル、テストクラスを生成します。
</p>
<h4>実行例</h4>
<p>
dao コマンドの説明では、<a href="http://s2dao.php5.sandbox.seasar.org/example.html">S2DaoのExample</a>で使用されているサンプルデータを用いて説明します。
</p>
<pre>
mysql> desc CD;
+---------+--------------+------+-----+---------+-------+
| Field   | Type         | Null | Key | Default | Extra |
+---------+--------------+------+-----+---------+-------+
| ID      | int(11)      | NO   | PRI |         |       |
| TITLE   | varchar(100) | YES  |     |         |       |
| CONTENT | varchar(200) | YES  |     |         |       |
+---------+--------------+------+-----+---------+-------+
3 rows in set (0.00 sec)

mysql> select * from CD;
+----+----------+---------+
| ID | TITLE    | CONTENT |
+----+----------+---------+
| 1  | S2Dao!!! | hello!! |
+----+----------+---------+
1 row in set (0.00 sec)

mysql>
</pre>
<br>

<p>s2base.php5 ディレクトリで phing を実行します。</p>
<pre>
% phing
Buildfile: /seasar.php/workspace/s2base.php5/build.xml

project &gt; prepare:
      [php] Evaluating PHP expression: require_once('config/environment.inc.php')
      [php] Evaluating PHP expression: require_once('lib/S2Base/S2Base.cmd.php')

project &gt; com:

[ Command list ]
0 : [ EXIT ]
1 : command
2 : dao
3 : dicon
4 : entity
5 : goya
6 : interceptor
7 : module
8 : service
choice ? : 2     &lt;--- 2 : dao を選択

[ Module list ]
0 : [ EXIT ]
1 : Default
choice ? : 1     &lt;--- 1 : Default モジュールを選択

dao interface name ? : CdDao                        &lt;--- 英数字 [_a-zA-Z0-9] が使用可能です。

entity class name ? : CdEntity                      &lt;--- 英数字 [_a-zA-Z0-9] が使用可能です。

table name ? [CdEntity] : CD                        &lt;--- データベースのテーブル名を設定。

columns ? [id,name,--, , ] : id,title,content       &lt;--- カンマ区切りでカラム名を入力
[INFO ] create : /seasar.php/workspace/s2base.php5/app/modules/Default/dao/CdDao.class.php
[INFO ] create : /seasar.php/workspace/s2base.php5/test/modules/Default/dao/CdDaoTest.class.php
[INFO ] create : /seasar.php/workspace/s2base.php5/app/modules/Default/dicon/CdDao.dicon
[INFO ] create : /seasar.php/workspace/s2base.php5/app/modules/Default/entity/CdEntity.class.php

BUILD FINISHED

Total time: 30.5662 seconds
%
</pre>

daoコマンドにより、PHPUnit2を用いたUnitTestクラスが作成されます。phing コマンドに test 引数を付けて実行すると、UnitTestが実行されます。
<pre>
% phing test -Dtd=modules/Default/dao     &lt;--- -D オプションで test ディレクトリ以下のディレクトリを指定できます。
Buildfile: /seasar.php/workspace/s2base.php5/build.xml

project > prepare:
      [php] Evaluating PHP expression: require_once('config/environment.inc.php')
      [php] Evaluating PHP expression: require_once('lib/S2Base/S2Base.cmd.php')

project > test:

CdDaoTest::testA
 [phpunit2] Testsuite: CdDaoTest
 [phpunit2] Tests run: 1, Failures: 0, Errors: 0, Time elapsed: 0.07924 sec

BUILD FINISHED

Total time: 0.6863 seconds
%
</pre>

dao コマンドにより生成されるDaoインタフェースは、デフォルトでいくつかのメソッドが定義済みです。
<pre>
% more app/modules/Default/dao/CdDao.class.php
&lt;?php
interface CdDao {
    const BEAN = "CdEntity";

    public function findAllArray();
    public function update(CdEntity $entity);
    public function insert(CdEntity $entity);
    public function delete(CdEntity $entity);
}
?&gt;
%
</pre>

例として、findAllArrayメソッドを実行してみます。まず、テストクラスにテストメソッドを追加します。

<pre>
% more test/modules/Default/dao/CdDaoTest.class.php
&lt;?php
class CdDaoTest extends PHPUnit2_Framework_TestCase {
    private $module = "Default";
    private $container;                      &lt;--- 各テストの前処理でS2Containerオブジェクトが設定されます。
    private $dao;                            &lt;--- 各テストの前処理でDaoオブジェクトが設定されます。

    function __construct($name) {
        parent::__construct($name);
    }

    function testFindAllArray() {            &lt;--- 追加テストメソッド
        print __METHOD__ . "\n";
        $rows = $this-&gt;dao-&gt;findAllArray();
        $entity = $rows[0];
        $this-&gt;assertTrue($entity instanceof CdEntity);
        $this-&gt;assertEquals($entity-&gt;getId(),'1');
        $this-&gt;assertEquals($entity-&gt;getTitle(),'S2Dao!!!');
        $this-&gt;assertEquals($entity-&gt;getContent(),'hello!!');
        print_r($entity);
    }

    function setUp(){
        print "\n";
        $moduleDir = S2BASE_PHP5_ROOT . "/app/modules/{$this-&gt;module}";
        $dicon = $moduleDir . "/dicon/CdDao" . S2BASE_PHP5_DICON_SUFFIX;
        include_once($moduleDir . "/{$this-&gt;module}.inc.php");
        $this-&gt;container = S2ContainerFactory::create($dicon);
        $this-&gt;dao = $this-&gt;container-&gt;getComponent("CdDao");
    }

    function tearDown() {
        $this-&gt;container = null;
        $this-&gt;dao = null;
    }
}
?&gt
%
</pre>

テストを実行すると、データベースから取得したデータを格納したEntitiyオブジェクトが表示されます。
<pre>
% phing test -Dtd=modules/Default/dao
Buildfile: /seasar.php/workspace/s2base.php5/build.xml

project &gt; prepare:
      [php] Evaluating PHP expression: require_once('config/environment.inc.php')
      [php] Evaluating PHP expression: require_once('lib/S2Base/S2Base.cmd.php')

project &gt; test:

CdDaoTest::testFindAllArray
CdEntity Object                          &lt;--- print_r($entity) でデバッグとして表示しています。
(
    [id:private] =&gt; 1
    [title:private] =&gt; S2Dao!!!
    [content:private] =&gt; hello!!
)
 [phpunit2] Testsuite: CdDaoTest
 [phpunit2] Tests run: 1, Failures: 0, Errors: 0, Time elapsed: 0.43753 sec

BUILD FINISHED

Total time: 1.0303 second
%
</pre>

<br>
<h3><a name="dicon">dicon コマンド</a></h3>
<h4>説明</h4>
<p>
XML形式のdiconファイルを生成します。
</p>
<h4>実行例</h4>
<p>s2base.php5 ディレクトリで phing を実行します。</p>

<pre>
% phing
Buildfile: /seasar.php/workspace/s2base.php5/build.xml

project &gt; prepare:
      [php] Evaluating PHP expression: require_once('config/environment.inc.php')
      [php] Evaluating PHP expression: require_once('lib/S2Base/S2Base.cmd.php')

project &gt; com:

[ Command list ]
0 : [ EXIT ]
1 : command
2 : dao
3 : dicon
4 : entity
5 : goya
6 : interceptor
7 : module
8 : service
choice ? : 3     &lt;--- 3 : dicon を選択

[ Module list ]
0 : [ EXIT ]
1 : Default
choice ? : 1     &lt;--- 1 : Default モジュールを選択

dicon name ? : sample    &lt;--- 英数字 [_a-zA-Z0-9] が使用可能です。
[INFO ] create : /seasar.php/workspace/s2base.php5/app/modules/Default/dicon/sample.dicon

BUILD FINISHED

Total time: 38.8949 seconds
%
</pre>
sample.dicon は空のダイコンファイルです。
<pre>
% more app/modules/Default/dicon/sample.dicon
&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;!DOCTYPE components PUBLIC "-//SEASAR//DTD S2Container//EN"
"http://www.seasar.org/dtd/components21.dtd"&gt;
&lt;components&gt;

&lt;/components&gt;
%
</pre>

<br>
<h3><a name="entity">entity コマンド</a></h3>
<h4>説明</h4>
<p>
S2Dao で用いる Entity クラスを作成します。columns でカンマ区切りのカラム名を入力すると、対応するプロパティとアクセッサメソッドを追加します。
</p>
<h4>実行例</h4>
<p>s2base.php5 ディレクトリで phing を実行します。</p>
<pre>
% phing
Buildfile: /seasar.php/workspace/s2base.php5/build.xml

project &gt; prepare:
      [php] Evaluating PHP expression: require_once('config/environment.inc.php')
      [php] Evaluating PHP expression: require_once('lib/S2Base/S2Base.cmd.php')

project &gt; com:

[ Command list ]
0 : [ EXIT ]
1 : command
2 : dao
3 : dicon
4 : entity
5 : goya
6 : interceptor
7 : module
8 : service
choice ? : 4     &lt;--- 4 : entity を選択

[ Module list ]
0 : [ EXIT ]
1 : Default
choice ? : 1     &lt;--- 1 : Default モジュールを選択

entity class name ? : DvdEntity                   &lt;--- 英数字 [_a-zA-Z0-9] が使用可能です。

table name ? [DvdEntity] : DVD                    &lt;--- データベースのテーブル名を設定

columns ? [id,name,--, , ] : id,title,content     &lt;--- カンマ区切りでカラム名を入力
[INFO ] create : /seasar.php/workspace/s2base.php5/app/modules/Default/entity/DvdEntity.class.php

BUILD FINISHED

Total time: 38.7971 seconds
%
</pre>
columns で、id、title、content を指定したので、3つのプロパティとそれぞのアクセッサメソッドが実装されます。
<pre>
% more app/modules/Default/entity/DvdEntity.class.php
&lt;?php
class DvdEntity {
    const TABLE = "DVD";
    public function __construct(){}

    private $id;
    public function setId($val){$this->id = $val;}
    public function getId(){return $this->id;}

    private $title;
    public function setTitle($val){$this->title = $val;}
    public function getTitle(){return $this->title;}

    private $content;
    public function setContent($val){$this->content = $val;}
    public function getContent(){return $this->content;}

}
?&gt;
%
</pre>

<br>
<h3><a name="goya">goya コマンド</a></h3>
<h4>説明</h4>
<p>
goya コマンドはサービス名を決めると、命名規則に従ってサービス、dao、enitity、ダイコンファイル、テストクラスを生成します。
<a href="#service">service コマンド</a>と<a href="#dao"> dao コマンド</a>を同時に実行することとほぼ同じ処理になります。
<br>例えば、サービス名を「 emp 」とすると、サービスは EmpService、dao は EmpDao、entity は EmpEntitiy となります。

</p>
<h4>実行例</h4>
<p>s2base.php5 ディレクトリで phing を実行します。</p>
<pre>
% phing
Buildfile: /seasar.php/workspace/s2base.php5/build.xml

project &gt; prepare:
      [php] Evaluating PHP expression: require_once('config/environment.inc.php')
      [php] Evaluating PHP expression: require_once('lib/S2Base/S2Base.cmd.php')

project &gt; com:

[ Command list ]
0 : [ EXIT ]
1 : command
2 : dao
3 : dicon
4 : entity
5 : goya
6 : interceptor
7 : module
8 : service
choice ? : 5             &lt;--- 5 : goya を選択

[ Module list ]
0 : [ EXIT ]
1 : Default
choice ? : 1             &lt;--- 1 : Default モジュールを選択

service name ? : emp     &lt;--- 英数字 [_a-zA-Z0-9] が使用可能です。

[ use commons dao ? ]
0 : [ EXIT ]
1 : yes
2 : no
choice ? : 2

table name ? [emp] : EMP                      &lt;--- データベースのテーブル名を設定

columns ? [id,name,--, , ] : id,name,dept     &lt;--- カンマ区切りでカラム名を入力
[INFO ] create : /seasar.php/workspace/s2base.php5/app/modules/Default/service/EmpServiceImpl.class.php
[INFO ] create : /seasar.php/workspace/s2base.php5/app/modules/Default/service/EmpService.class.php
[INFO ] create : /seasar.php/workspace/s2base.php5/test/modules/Default/service/EmpServiceImplTest.class.php
[INFO ] create : /seasar.php/workspace/s2base.php5/app/modules/Default/dao/EmpDao.class.php
[INFO ] create : /seasar.php/workspace/s2base.php5/test/modules/Default/dao/EmpDaoTest.class.php
[INFO ] create : /seasar.php/workspace/s2base.php5/app/modules/Default/entity/EmpEntity.class.php
[INFO ] create : /seasar.php/workspace/s2base.php5/app/modules/Default/dicon/EmpService.dicon

BUILD FINISHED

Total time: 1 minutes  13.67 seconds
%
</pre>
[ commons dao ] については、<a href="#gen-dao">gen-dao タスク</a>を参照下さい。<br>
goya コマンドで生成されるダイコンファイルでは、サービスと dao コンポーネントが登録済みです。
<pre>
% more app/modules/Default/dicon/EmpService.dicon
&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;!DOCTYPE components PUBLIC "-//SEASAR//DTD S2Container//EN"
"http://www.seasar.org/dtd/components21.dtd"&gt;
&lt;components&gt;
    &lt;include path="%S2BASE_PHP5_ROOT%/app/commons/dicon/dao.dicon"/&gt;
    &lt;component class="EmpServiceImpl"/&gt;
    &lt;component class="EmpDao"&gt;
        &lt;aspect&gt;dao.interceptor&lt;/aspect&gt;
    &lt;/component&gt;
&lt;/components&gt;
%
</pre>

また、EmpServiceImplクラスでは EmpDao へのセッターメソッドが定義済みなので、サービスに dao が自動インジェクションされます。
<pre>
% more app/modules/Default/service/EmpServiceImpl.class.php
&lt;?php
class EmpServiceImpl
    implements EmpService {
    private $dao;

    public function __construct(){}

    public function setDao(EmpDao $dao){
        $this->dao = $dao;
    }
}
?&gt;
%
</pre>

<br>
<h3><a name="interceptor">interceptor コマンド</a></h3>
<h4>説明</h4>
<p>
S2Aop の MethodInterceptor を実装するクラスを生成します。
</p>
<h4>実行例</h4>
<p>s2base.php5 ディレクトリで phing を実行します。</p>
<pre>
 % phing
Buildfile: /seasar.php/workspace/s2base.php5/build.xml

project &gt; prepare:
      [php] Evaluating PHP expression: require_once('config/environment.inc.php')
      [php] Evaluating PHP expression: require_once('lib/S2Base/S2Base.cmd.php')

project &gt; com:

[ Command list ]
0 : [ EXIT ]
1 : command
2 : dao
3 : dicon
4 : entity
5 : goya
6 : interceptor
7 : module
8 : service
choice ? : 6     &lt;--- 6 : interceptor を選択

[ Module list ]
0 : [ EXIT ]
1 : Default
choice ? : 1     &lt;--- 1 : Default モジュールを選択

interceptor class name ? : HogeInterceptor     &lt;--- 英数字 [_a-zA-Z0-9] が使用可能です。
[INFO ] create : /seasar.php/workspace/s2base.php5/app/modules/Default/interceptor/HogeInterceptor.class.php

BUILD FINISHED

Total time: 17.2060 seconds
%
</pre>

S2Container_AbstractInterceptor を継承した interceptor を生成します。参照：<a href="http://s2container.php5.sandbox.seasar.org/aop.html#OriginalInterceptor">独自実装によるInterceptor</a>

<pre>
% more app/modules/Default/interceptor/HogeInterceptor.class.php
&lt;?php
class HogeInterceptor
    extends S2Container_AbstractInterceptor {

    /**
     * @param S2Container_MethodInvocation $invocation
     *    - $invocation->getThis()      : return target object
     *    - $invocation->getMethod()    : return ReflectionMethod of target method
     *    - $invocation->getArguments() : return array of method arguments
     */
    public function invoke(S2Container_MethodInvocation $invocation) {
        return $invocation->proceed();
    }
}
?&gt;
%
</pre>

<br>
<h3><a name="module">module コマンド</a></h3>
<h4>説明</h4>
<p>
app/modules ディレクトリと test/modules ディレクトリに<a href="dir.html">モジュールディレクトリ</a>を作成します。
app/modules/モジュールディレクトリには、dao、dicon、entity、interceptor、serviceディレクトリが作成されます。
</p>
<h4>実行例</h4>
<p>s2base.php5 ディレクトリで phing を実行します。</p>
<pre>
% phing
Buildfile: /seasar.php/workspace/s2base.php5/build.xml

project > prepare:
      [php] Evaluating PHP expression: require_once('config/environment.inc.php')
      [php] Evaluating PHP expression: require_once('lib/S2Base/S2Base.cmd.php')

project > com:

[ Command list ]
0 : [ EXIT ]
1 : command
2 : dao
3 : dicon
4 : entity
5 : goya
6 : interceptor
7 : module
8 : service
choice ? : 7               &lt;--- 7 : module を選択

module name ? : Default    &lt;--- モジュール名を入力。英数字 [_a-zA-Z0-9] が使用可能です。
[INFO ] create : /seasar.php/workspace/s2base.php5/app/modules/Default
[INFO ] create : /seasar.php/workspace/s2base.php5/app/modules/Default/dao/
[INFO ] create : /seasar.php/workspace/s2base.php5/app/modules/Default/dicon/
[INFO ] create : /seasar.php/workspace/s2base.php5/app/modules/Default/entity/
[INFO ] create : /seasar.php/workspace/s2base.php5/app/modules/Default/interceptor/
[INFO ] create : /seasar.php/workspace/s2base.php5/app/modules/Default/service/
[INFO ] create : /seasar.php/workspace/s2base.php5/test/modules/Default
[INFO ] create : /seasar.php/workspace/s2base.php5/test/modules/Default/dao/
[INFO ] create : /seasar.php/workspace/s2base.php5/test/modules/Default/service/
[INFO ] create : /seasar.php/workspace/s2base.php5/app/modules/Default/Default.inc.php

BUILD FINISHED

Total time: 8.2091 seconds
%
</pre>

app ディレクトリと test ディレクトリ以下にDefaultモジュールが作成されます。
<pre>
% ls app/modules/Default
Default.inc.php  dao  dicon  entity  interceptor  service
% ls test/modules/Default
dao  service
%
</pre>

<br>
<h3><a name="service">service コマンド</a></h3>
<h4>説明</h4>
<p>
サービスインタフェース、実装クラス、ダイコンファイル、テストクラスを生成します。
</p>
<h4>実行例</h4>
<p>s2base.php5 ディレクトリで phing を実行します。</p>
<pre>
% phing
Buildfile: /seasar.php/workspace/s2base.php5/build.xml

project > prepare:
      [php] Evaluating PHP expression: require_once('config/environment.inc.php')
      [php] Evaluating PHP expression: require_once('lib/S2Base/S2Base.cmd.php')

project > com:

[ Command list ]
0 : [ EXIT ]
1 : command
2 : dao
3 : dicon
4 : entity
5 : goya
6 : interceptor
7 : module
8 : service
choice ? : 8     &lt;--- 8 : service を選択

[ Module list ]
0 : [ EXIT ]
1 : Default
choice ? : 1     &lt;--- 1 : Default モジュールを選択

service interface name ? : CulcService     &lt;--- 英数字 [_a-zA-Z0-9] が使用可能です。
[INFO ] create : /seasar.php/workspace/s2base.php5/app/modules/Default/service/CulcServiceImpl.class.php
[INFO ] create : /seasar.php/workspace/s2base.php5/app/modules/Default/service/CulcService.class.php
[INFO ] create : /seasar.php/workspace/s2base.php5/test/modules/Default/service/CulcServiceImplTest.class.php
[INFO ] create : /seasar.php/workspace/s2base.php5/app/modules/Default/dicon/CulcService.dicon

BUILD FINISHED

Total time: 12.7848 seconds
%
</pre>
service コマンドにより PHPUnit2 を用いた UnitTest クラスが作成されます。phing コマンドに test 引数を付けて実行すると UnitTest を実行できます。
<pre>
% phing test -Dtd=modules/Default/service
Buildfile: /seasar.php/workspace/s2base.php5/build.xml

project > prepare:
      [php] Evaluating PHP expression: require_once('config/environment.inc.php')
      [php] Evaluating PHP expression: require_once('lib/S2Base/S2Base.cmd.php')

project > test:

CulcServiceImplTest::testA
 [phpunit2] Testsuite: CulcServiceImplTest
 [phpunit2] Tests run: 1, Failures: 0, Errors: 0, Time elapsed: 0.01326 sec

BUILD FINISHED

Total time: 0.5984 seconds
%
</pre>
例として、サービスクラスに add メソッドを追加します。
<pre>
% more app/modules/Default/service/CulcServiceImpl.class.php
&lt;?php
class CulcServiceImpl
    implements CulcService{
    public function __construct(){}

    public function add($a,$b){         &lt;--- 足し算メソッドを追加
        return $a + $b;
    }
}
?&gt;
%
</pre>

テストクラスに add メソッドをテストするテストメソッドを追加します。
<pre>
% more test/modules/Default/service/CulcServiceImplTest.class.php
&lt;?php
class CulcServiceImplTest extends PHPUnit2_Framework_TestCase {
    private $module = "Default";
    private $serviceName = "CulcService";
    private $container;                       &lt;--- 各テストの前処理でS2Containerオブジェクトが設定されます。
    private $service;                         &lt;--- 各テストの前処理でサービスオブジェクトが設定されます。

    function __construct($name) {
        parent::__construct($name);
    }

    function testAdd() {                  &lt;--- テストメソッドを追加
        print __METHOD__ . "\n";
        $a = 2;
        $b = 3;
        $c = $this-&gt;service-&gt;add($a,$b);
        $this-&gt;assertEquals($c,5);
        print "$a + $b = $c \n";
    }

    function setUp(){
        print "\n";
        $moduleDir = S2BASE_PHP5_ROOT . "/app/modules/{$this-&gt;module}";
        $dicon = $moduleDir . "/dicon/CulcService" . S2BASE_PHP5_DICON_SUFFIX;
        include_once($moduleDir . "/{$this-&gt;module}.inc.php");
        $this-&gt;container = S2ContainerFactory::create($dicon);
        $this-&gt;service = $this-&gt;container-&gt;getComponent("CulcService");
    }

    function tearDown() {
        $this-&gt;container = null;
        $this-&gt;service = null;
    }

}
?&gt;
%
</pre>

phing コマンドに test 引数を付けて実行すると UnitTest を実行できます。
<pre>
% phing test -Dtd=modules/Default/service
Buildfile: /seasar.php/workspace/s2base.php5/build.xml

project > prepare:
      [php] Evaluating PHP expression: require_once('config/environment.inc.php')
      [php] Evaluating PHP expression: require_once('lib/S2Base/S2Base.cmd.php')

project > test:

CulcServiceImplTest::testAdd
2 + 3 = 5                     &lt;--- デバッグとして、足し算式を表示します。
 [phpunit2] Testsuite: CulcServiceImplTest
 [phpunit2] Tests run: 1, Failures: 0, Errors: 0, Time elapsed: 0.01385 sec

BUILD FINISHED

Total time: 0.6278 seconds
%
</pre>


<br>
<h3><a name="test">test タスク</a></h3>
<h4>説明</h4>
<p>
S2Base コマンドの service、dao、goya では、UnitTestが生成されます。これらの UnitTest を実行するタスクです。
</p>
<h4>実行例</h4>
<p>s2base.php5 ディレクトリで phing test を実行します。test ディレクトリにある全テストを実行します。</p>
<pre>
% phing test
Buildfile: /seasar.php/workspace/s2base.php5/build.xml

project &gt; prepare:
      [php] Evaluating PHP expression: require_once('config/environment.inc.php')
      [php] Evaluating PHP expression: require_once('lib/S2Base/S2Base.cmd.php')

project &gt; test:
     [echo] test directory : test/         &lt;--- test ディレクトリ以下の全テスト

CdDaoTest::testFindAllArray
CdEntity Object
(
    [id:private] => 1
    [title:private] => S2Dao!!!
    [content:private] => hello!!
)
 [phpunit2] Testsuite: CdDaoTest
 [phpunit2] Tests run: 1, Failures: 0, Errors: 0, Time elapsed: 0.20118 sec

CulcServiceImplTest::testAdd
2 + 3 = 5
 [phpunit2] Testsuite: CulcServiceImplTest
 [phpunit2] Tests run: 1, Failures: 0, Errors: 0, Time elapsed: 0.00723 sec

BUILD FINISHED

Total time: 0.8004 seconds
%
</pre>

phing コマンドのオプション -Dプロパティ名 を使用して、test ディレクトリ以下の任意のディレクトリを指定できます。プロパティ名は「 td 」です。
<pre>
% phing test -Dtd=modules/Default/dao
Buildfile: /seasar.php/workspace/s2base.php5/build.xml

project &gt; prepare:
      [php] Evaluating PHP expression: require_once('config/environment.inc.php')
      [php] Evaluating PHP expression: require_once('lib/S2Base/S2Base.cmd.php')

project &gt; test:
     [echo] test directory : test/modules/Default/dao     &lt;--- dao サブディレクトリ以下の全テスト

CdDaoTest::testFindAllArray
CdEntity Object
(
    [id:private] => 1
    [title:private] => S2Dao!!!
    [content:private] => hello!!
)
 [phpunit2] Testsuite: CdDaoTest
 [phpunit2] Tests run: 1, Failures: 0, Errors: 0, Time elapsed: 0.20403 sec

BUILD FINISHED

Total time: 0.7715 seconds
%
</pre>

<br>
<h3><a name="gen-dao">gen-dao タスク</a></h3>
<h4>説明</h4>
<p>
S2Dao に付属の S2DaoSkeletonTask を用いて、app/commons/dao ディレクトリにデータベースの全テーブルの dao と entity を生成します。
</p>
<h4>実行例</h4>
<p>データベースに次のようなサンプルテーブルを複数用意しています。</p>
<pre>
mysql&gt; show tables;
+-----------------------+
| Tables_in_s2container |
+-----------------------+
| CD                    |
| DEPT                  |
| EMP                   |
| SHELF                 |
+-----------------------+
4 rows in set (0.00 sec)

mysql&gt;
</pre>

build.xml の gen-dao タスクで、DSN設定を行います。
<pre>
&lt;?xml version="1.0"?&gt;
&lt;project name="project" default="com" basedir="."&gt;
    ・・・
    &lt;target name="gen-dao" depends="prepare"&gt;
        &lt;property name="dsn" value="mysql:host=localhost; dbname=s2container" /&gt;
        &lt;property name="user" value="root" /&gt;
        &lt;property name="password" value="test" /&gt;
        &lt;gdao toDir="app/commons/dao" /&gt;
    &lt;/target&gt;
    ・・・
&lt;/project&gt;
</pre>

s2base.php5 ディレクトリで phing gen-dao を実行します。
<pre>
% phing gen-dao
Buildfile: /seasar.php/workspace/s2base.php5/build.xml

project &gt; prepare:
      [php] Evaluating PHP expression: require_once('config/environment.inc.php')
      [php] Evaluating PHP expression: require_once('lib/S2Base/S2Base.cmd.php')

project &gt; gen-dao:
     [gdao] [create] [DAO]: CDDao
     [gdao] [create] [BEAN]: CDEntity
     [gdao] [create] [DAO]: DEPTDao
     [gdao] [create] [BEAN]: DEPTEntity
     [gdao] [create] [DAO]: EMPDao
     [gdao] [create] [BEAN]: EMPEntity
     [gdao] [create] [DAO]: SHELFDao
     [gdao] [create] [BEAN]: SHELFEntity
     [gdao] [INFO] see the files
     [gdao] [file]: app/commons/dao/CDDao.class.php
     [gdao] [file]: app/commons/dao/CDEntity.class.php
     [gdao] [file]: app/commons/dao/DEPTDao.class.php
     [gdao] [file]: app/commons/dao/DEPTEntity.class.php
     [gdao] [file]: app/commons/dao/EMPDao.class.php
     [gdao] [file]: app/commons/dao/EMPEntity.class.php
     [gdao] [file]: app/commons/dao/SHELFDao.class.php
     [gdao] [file]: app/commons/dao/SHELFEntity.class.php

BUILD FINISHED

Total time: 0.6476 seconds
%
% ls app/commons/dao
CDDao.class.php     DEPTDao.class.php     EMPDao.class.php     SHELFDao.class.php
CDEntity.class.php  DEPTEntity.class.php  EMPEntity.class.php  SHELFEntity.class.php
%
</pre>


<!-- document end -->
<!-- don't edit start -->
</td>
<td width="14"><img src="images/spacer.gif" alt="" height="14" width="14"></td>
</tr><tr>
<td width="14"><img src="images/spacer.gif" alt="" height="30" width="14"></td>
<td width="766"><img src="images/spacer.gif" alt="" height="30" width="592"></td>
</tr><tr>
<td width="14"><img src="images/spacer.gif" alt="" height="14" width="14"></td>
<td class="copyright" width="766">&#169; Copyright The Seasar Project and the others 2005-2006, all rights reserved.</td>
</tr></tbody></table>
</td><td class="backright" align="left" valign="top">&nbsp;</td></tr><tr>
<td class="backunder" align="left" height="16" valign="top" width="780">&nbsp;</td>
<td class="backcorner" align="left" height="16" valign="top">&nbsp;</td>
</tr></tbody></table><!-- don't edit end -->
</body></html>